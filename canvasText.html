<!DOCTYPE html>
<html>
	<head>
		<title> canvas test </title>
		<style>
			#can {
				border: 1px solid black;
			}
		</style>
	</head>
	<body>
		<canvas id="can" width="400" height="300"></canvas>
		<div id="textBox" class="none">
			<input type="text">
			<button id="addText">AddText</button>
		</div>
	<script>
		var can = document.querySelector('#can'); //전역
		var textList = [];
		var choosed = null;
		var mousePointX = null;
		var mousePointY = null;
		// mouse event

		can.addEventListener('mousedown', mouseDown);
		can.addEventListener('mousemove', mouseMove);
		can.addEventListener('mouseup', mouseUp);

		function mouseDown(e){
			mousePointX = e.clientX - can.offsetLeft;
			mousePointY = e.clientY - can.offsetTop;

			textList.forEach(function(el){
				if(el.minX <= mousePointX && mousePointX <= el.maxX 
					&& el.minY <= mousePointY && mousePointY <= el.maxY){
					choosed = el;
					return;
				}
			});
		}

		function mouseMove(e){
			if(choosed == null){
				return;
			}

			var xMove = e.clientX - mousePointX;
			var yMove = e.clientY - mousePointY;
			mousePointX = e.clientX;
			mousePointY = e.clientY;
			choosed.x += xMove;
			choosed.minX += xMove;
			choosed.maxX += xMove;
			choosed.y += yMove;
			choosed.minY += yMove;
			choosed.maxY += yMove;
			canvasRedraw();
		}

		function mouseUp(e){
			choosed = null;
			mousePointX = null;
			mousePointY = null;
		}

		function drawText(text){
			this.tmp = text;

			this.x = 0;
			this.y = 20 * 0.85;
			this.ctx = can.getContext('2d');
			this.ctx.font = "20px Arial";
			this.minX = 0
			this.maxX = this.minX + parseInt(this.ctx.measureText(text).width);
			this.minY = 0;
			this.maxY = this.minY + parseInt(this.ctx.font);
			this.draw = function(){
				this.ctx.fillText(text, this.x, this.y);	
			}		
		}

		var addTxt = document.querySelector('#addText');
		addTxt.addEventListener('click', insertText);

		function insertText(){
			var textValue = document.querySelector('#textBox input').value;
			var text = new drawText(textValue);
			text.draw();
			textList.push(text);
			document.querySelector('#textBox input').value = "";
		}

		function canvasRedraw(){
			if(textList.length == 0) return;
			textList[0].ctx.clearRect(0, 0, can.getAttribute('width'), can.getAttribute('height'));
			textList.forEach(function(aText){ 
				aText.draw();
			});
		}

	</script>
	</body>
</html>